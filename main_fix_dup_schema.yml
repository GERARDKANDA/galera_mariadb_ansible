---
- name: Configure MariaDB Galera Cluster
  hosts: galera-cluster-nodes
  become: true
  pre_tasks:
    - name: Ensure /etc/mysql/conf.d directory exists
      file:
        path: /etc/mysql/conf.d
        state: directory
        owner: mysql
        group: mysql
        mode: '0755'
  roles:
    - mrlesmithjr.mariadb_galera_cluster
  vars:
    mariadb_galera_cluster_name: my_cluster
    mariadb_galera_cluster_nodes: "{{ groups['galera-cluster-nodes'] }}"
    mariadb_galera_cluster_bootstrap_node: ip-172.26.4.253
    galera_mysql_first_node: ip-172.26.4.253
    galera_cluster_nodes: "{{ groups['galera-cluster-nodes'] }}"
    galera_cluster_bind_interface: ens5
    mariadb_upgrade: true  # Add this line to allow upgrading MariaDB

  tasks:
    - name: Bootstrap the primary node
      shell: |
        sudo systemctl stop mariadb
        sudo galera_new_cluster
        sudo systemctl status mariadb
      when: ansible_host == mariadb_galera_cluster_bootstrap_node
      ignore_errors: true

    - name: Start MariaDB on other nodes
      shell: sudo systemctl start mariadb
      when: ansible_host != mariadb_galera_cluster_bootstrap_node
      ignore_errors: true

    - name: Wait for MariaDB to start on bootstrap node
      wait_for:
        port: 3306
        host: "{{ ansible_host }}"
        state: started
        delay: 10
      when: ansible_host == mariadb_galera_cluster_bootstrap_node

    - name: Wait for MariaDB to start on other nodes
      wait_for:
        port: 3306
        host: "{{ ansible_host }}"
        state: started
        delay: 10
      when: ansible_host != mariadb_galera_cluster_bootstrap_node

    - name: Create kanda database
      mysql_db:
        name: kanda
      when: ansible_host == mariadb_galera_cluster_bootstrap_node

    - name: Copy schema file to target hosts
      copy:
        src: /home/gkipngok/ansible-mariadb-galera/db_schema/kandas.sql  # Update this path to the location of your schema file on the Ansible control machine
        dest: /tmp/kandas.sql
        mode: '0644'
      when: ansible_host == mariadb_galera_cluster_bootstrap_node

    - name: Restore schema from backup file using MySQL client
      shell: mysql -u root kanda < /tmp/nation.sql
      when: ansible_host == mariadb_galera_cluster_bootstrap_node

