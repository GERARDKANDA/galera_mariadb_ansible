---
- name: Configure MariaDB Galera Cluster
  hosts: galera-cluster-nodes
  become: true
  pre_tasks:
    - name: Ensure /etc/mysql/conf.d directory exists
      file:
        path: /etc/mysql/conf.d
        state: directory
        owner: mysql
        group: mysql
        mode: '0755'
  roles:
    - mrlesmithjr.mariadb_galera_cluster
  vars:
    mariadb_galera_cluster_name: my_cluster
    mariadb_galera_cluster_nodes: "{{ groups['galera-cluster-nodes'] }}"
    mariadb_galera_cluster_bootstrap_node: ip-172.26.4.253
    galera_mysql_first_node: ip-172.26.4.253
    galera_cluster_nodes: "{{ groups['galera-cluster-nodes'] }}"
    galera_cluster_bind_interface: ens5
    #mariadb_upgrade: true  # Add this line to allow upgrading MariaDB

  tasks:
    - name: Create db_nations database
      mysql_db:
        name: db_nations

    - name: Copy schema file to target hosts
      copy:
        src: /home/gkipngok/ansible-mariadb-galera/db_schema/nation.sql  # Update this path to the location of your schema file on the Ansible control machine
        dest: /tmp/nation.sql
        mode: '0644'

    - name: Restore schema from backup file using MySQL client
      shell: mysql -u root db_nations < /tmp/nation.sql
